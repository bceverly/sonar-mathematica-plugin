name: Code Quality Check

on:
  push:
    branches: [ "**" ]  # Run on all branches
  pull_request:
    branches: [ "**" ]  # Run on all PRs

jobs:
  lint:
    name: Zero-Tolerance Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for deprecation warnings (ZERO TOLERANCE)
        run: |
          echo "========================================="
          echo "JAVA DEPRECATION CHECK - ZERO TOLERANCE"
          echo "========================================="
          echo ""
          echo "Compiling with deprecation warnings enabled..."
          ./gradlew compileJava compileTestJava --no-daemon --console=plain > /tmp/compile_output.log 2>&1

          # Count deprecation warnings (excluding test unchecked warnings)
          DEPRECATION_WARNINGS=$(grep -c "warning: \[deprecation\]" /tmp/compile_output.log || echo "0")

          echo ""
          echo "Deprecation warnings found: $DEPRECATION_WARNINGS"
          echo ""

          if [ "$DEPRECATION_WARNINGS" -gt 0 ]; then
            echo "‚ùå FAILURE: Deprecation warnings detected!"
            echo ""
            echo "This repository enforces ZERO-TOLERANCE for deprecation warnings."
            echo "Even a single deprecation warning will fail the build."
            echo ""
            echo "==============================================="
            echo "DEPRECATION WARNING DETAILS:"
            echo "==============================================="
            echo ""
            grep "warning: \[deprecation\]" /tmp/compile_output.log -B2 -A2 | head -50
            if [ "$DEPRECATION_WARNINGS" -gt 10 ]; then
              echo ""
              echo "... and $((DEPRECATION_WARNINGS - 10)) more warnings"
            fi
            echo ""
            echo "==============================================="
            echo "HOW TO FIX:"
            echo "==============================================="
            echo "1. Run locally: ./gradlew compileJava -Xlint:deprecation"
            echo "2. Update deprecated API usage to current API"
            echo "3. Run 'make lint' to verify all warnings are fixed"
            echo "4. Push changes after achieving zero warnings"
            echo ""
            exit 1
          else
            echo "‚úÖ SUCCESS: ZERO deprecation warnings!"
            echo ""
            echo "üéâ All code uses current APIs!"
            echo "‚ú® No deprecated API usage detected!"
            echo ""
          fi

      - name: Run Checkstyle on main sources
        id: checkstyle_main
        run: |
          echo "Running Checkstyle on main sources..."
          ./gradlew checkstyleMain --no-daemon --console=plain

      - name: Run Checkstyle on test sources
        id: checkstyle_test
        run: |
          echo "Running Checkstyle on test sources..."
          ./gradlew checkstyleTest --no-daemon --console=plain

      - name: Parse Checkstyle results (ZERO TOLERANCE)
        run: |
          echo "========================================="
          echo "CHECKSTYLE RESULTS - ZERO TOLERANCE MODE"
          echo "========================================="

          # Count violations in main sources
          MAIN_VIOLATIONS=0
          if [ -f build/reports/checkstyle/main.xml ]; then
            MAIN_VIOLATIONS=$(grep -c "<error" build/reports/checkstyle/main.xml || echo "0")
          fi

          # Count violations in test sources
          TEST_VIOLATIONS=0
          if [ -f build/reports/checkstyle/test.xml ]; then
            TEST_VIOLATIONS=$(grep -c "<error" build/reports/checkstyle/test.xml || echo "0")
          fi

          TOTAL_VIOLATIONS=$((MAIN_VIOLATIONS + TEST_VIOLATIONS))

          echo ""
          echo "Main sources violations: $MAIN_VIOLATIONS"
          echo "Test sources violations: $TEST_VIOLATIONS"
          echo "Total violations: $TOTAL_VIOLATIONS"
          echo ""

          if [ $TOTAL_VIOLATIONS -gt 0 ]; then
            echo "‚ùå FAILURE: Code quality check FAILED!"
            echo ""
            echo "This repository enforces ZERO-TOLERANCE for code quality violations."
            echo "Even a single Checkstyle warning will fail the build."
            echo ""
            echo "==============================================="
            echo "VIOLATION DETAILS:"
            echo "==============================================="

            # Show main violations if any
            if [ $MAIN_VIOLATIONS -gt 0 ]; then
              echo ""
              echo "üìã Main source violations ($MAIN_VIOLATIONS):"
              echo "---"
              grep "<error" build/reports/checkstyle/main.xml | head -20 || true
              if [ $MAIN_VIOLATIONS -gt 20 ]; then
                echo "... and $((MAIN_VIOLATIONS - 20)) more violations"
              fi
            fi

            # Show test violations if any
            if [ $TEST_VIOLATIONS -gt 0 ]; then
              echo ""
              echo "üìã Test source violations ($TEST_VIOLATIONS):"
              echo "---"
              grep "<error" build/reports/checkstyle/test.xml | head -20 || true
              if [ $TEST_VIOLATIONS -gt 20 ]; then
                echo "... and $((TEST_VIOLATIONS - 20)) more violations"
              fi
            fi

            echo ""
            echo "==============================================="
            echo "HOW TO FIX:"
            echo "==============================================="
            echo "1. Run locally: ./gradlew checkstyleMain checkstyleTest"
            echo "2. View full reports:"
            echo "   - build/reports/checkstyle/main.html"
            echo "   - build/reports/checkstyle/test.html"
            echo "3. Fix all violations before pushing"
            echo "4. Verify: ./gradlew check"
            echo ""

            exit 1
          else
            echo "‚úÖ SUCCESS: ZERO violations detected!"
            echo ""
            echo "üéâ Code quality is perfect!"
            echo "‚ú® All checks passed with flying colors!"
            echo ""
          fi

      - name: Run full build (includes tests)
        run: |
          echo "Running full build with tests..."
          ./gradlew build --no-daemon --console=plain

      - name: Upload Checkstyle reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-reports
          path: |
            build/reports/checkstyle/
          retention-days: 30

      - name: Final status
        if: success()
        run: |
          echo "================================================"
          echo "‚úÖ ALL CHECKS PASSED!"
          echo "================================================"
          echo ""
          echo "‚úì Deprecation warnings: ZERO"
          echo "‚úì Checkstyle: ZERO violations"
          echo "‚úì Build: SUCCESS"
          echo "‚úì Tests: PASSED"
          echo ""
          echo "Code quality standards maintained! üöÄ"
          echo ""
