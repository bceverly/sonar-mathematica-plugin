name: Deploy New Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-marketplace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wolfralyze
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and version info
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0)
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix if present

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Latest version: $VERSION (tag: $LATEST_TAG)"

      - name: Load release notes
        id: release_notes
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ ! -f "RELEASE_NOTES.md" ]; then
            echo "âŒ Error: RELEASE_NOTES.md not found!"
            echo ""
            echo "Please run 'make release-notes' and commit the file before running this workflow."
            exit 1
          fi

          echo "ðŸ“‹ Extracting release notes for version ${VERSION} from RELEASE_NOTES.md"

          # Extract just the section for this version
          awk "/^## Version ${VERSION}\$/,/^## Version [0-9]/" RELEASE_NOTES.md | sed '$d' > current_release_notes.md

          # If extraction failed or file is empty, use a default message
          if [ ! -s current_release_notes.md ]; then
            echo "âš ï¸  Warning: Could not extract notes for version ${VERSION}, using default"
            echo "## Version ${VERSION}" > current_release_notes.md
            echo "" >> current_release_notes.md
            echo "See full release notes at: https://github.com/bceverly/wolfralyze/blob/master/RELEASE_NOTES.md" >> current_release_notes.md
          fi

          # Save to output
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat current_release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Release notes for version ${VERSION}:"
          cat current_release_notes.md

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build plugin
        run: |
          ./gradlew clean build
          echo "âœ… Plugin built successfully"

      - name: Verify JAR exists
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          JAR_PATH="build/libs/wolfralyze-${VERSION}.jar"

          if [ ! -f "$JAR_PATH" ]; then
            echo "âŒ Error: JAR not found at $JAR_PATH"
            exit 1
          fi

          echo "âœ… JAR verified at $JAR_PATH"

      # Step 1: Update sonar-update-center-properties
      - name: Clone sonar-update-center-properties
        run: |
          git clone https://github.com/SonarSource/sonar-update-center-properties.git
          echo "âœ… Cloned sonar-update-center-properties"

      - name: Update wolfralyze.properties
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
        run: |
          cd sonar-update-center-properties
          TODAY=$(date +%Y-%m-%d)

          # Update the properties file
          PROPS_FILE="wolfralyze.properties"

          # Add new version to publicVersions (append to existing list)
          sed -i "s/publicVersions=\(.*\)/publicVersions=\1,$VERSION/" $PROPS_FILE

          # Add version-specific properties
          echo "" >> $PROPS_FILE
          echo "$VERSION.description=Bug fixes and improvements" >> $PROPS_FILE
          echo "$VERSION.sqs=[2025.1,LATEST]" >> $PROPS_FILE
          echo "$VERSION.sqcb=[24.12,LATEST]" >> $PROPS_FILE
          echo "$VERSION.downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar" >> $PROPS_FILE
          echo "$VERSION.changelogUrl=https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}" >> $PROPS_FILE
          echo "$VERSION.date=${TODAY}" >> $PROPS_FILE

          echo "âœ… Updated wolfralyze.properties"
          echo "ðŸ“„ Changes:"
          git diff $PROPS_FILE

      - name: Create PR for sonar-update-center-properties
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonar-update-center-properties

          # Configure git with user's identity
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add wolfralyze.properties
          git commit -m "Add wolfralyze ${VERSION}"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonar-update-center-properties.git
          git push fork $BRANCH

          # Create PR body
          echo "Updates wolfralyze plugin to version ${VERSION}." > pr_body.txt
          echo "" >> pr_body.txt
          cat ../current_release_notes.md >> pr_body.txt
          echo "" >> pr_body.txt
          echo "---" >> pr_body.txt
          echo "*This PR was automatically generated by the wolfralyze release workflow.*" >> pr_body.txt

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonar-update-center-properties \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION}" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonar-update-center-properties"

      # Step 2: Update sonarqube-community-branch-plugin-builds
      - name: Clone sonarqube-community-branch-plugin-builds
        run: |
          git clone https://github.com/SonarSource/sonarqube-community-branch-plugin-builds.git
          echo "âœ… Cloned sonarqube-community-branch-plugin-builds"

      - name: Update build metadata
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
        run: |
          cd sonarqube-community-branch-plugin-builds

          # Create metadata file for the new version
          mkdir -p metadata/wolfralyze
          TODAY=$(date +%Y-%m-%d)

          # Write JSON file
          cat > metadata/wolfralyze/${VERSION}.json << 'JSON_EOF'
{
JSON_EOF
          echo "  \"version\": \"${VERSION}\"," >> metadata/wolfralyze/${VERSION}.json
          echo "  \"downloadUrl\": \"https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar\"," >> metadata/wolfralyze/${VERSION}.json
          echo "  \"changelogUrl\": \"https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}\"," >> metadata/wolfralyze/${VERSION}.json
          echo "  \"compatibleSQVersions\": [\"2025.1\", \"LATEST\"]," >> metadata/wolfralyze/${VERSION}.json
          echo "  \"date\": \"${TODAY}\"" >> metadata/wolfralyze/${VERSION}.json
          echo "}" >> metadata/wolfralyze/${VERSION}.json

          echo "âœ… Created metadata file"
          cat metadata/wolfralyze/${VERSION}.json

      - name: Create PR for sonarqube-community-branch-plugin-builds
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonarqube-community-branch-plugin-builds

          # Configure git with user's identity
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add metadata/wolfralyze/${VERSION}.json
          git commit -m "Add wolfralyze ${VERSION} to marketplace"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonarqube-community-branch-plugin-builds.git
          git push fork $BRANCH

          # Create PR body
          echo "Adds wolfralyze plugin version ${VERSION} to the SonarQube marketplace." > pr_body.txt
          echo "" >> pr_body.txt
          cat ../current_release_notes.md >> pr_body.txt
          echo "" >> pr_body.txt
          echo "**Download URL:** https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar" >> pr_body.txt
          echo "" >> pr_body.txt
          echo "---" >> pr_body.txt
          echo "*This PR was automatically generated by the wolfralyze release workflow.*" >> pr_body.txt

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonarqube-community-branch-plugin-builds \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION} to marketplace" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonarqube-community-branch-plugin-builds"

      - name: Summary
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## ðŸŽ‰ Release Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** $LATEST_TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" == "true" ]; then
            echo "**Mode:** Dry run (no PRs created)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**PRs Created:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonar-update-center-properties" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonarqube-community-branch-plugin-builds" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes for Version $VERSION" >> $GITHUB_STEP_SUMMARY
          cat current_release_notes.md >> $GITHUB_STEP_SUMMARY
