name: Deploy New Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-marketplace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wolfralyze
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get latest tag and version info
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0)
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix if present

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Latest version: $VERSION (tag: $LATEST_TAG)"

      - name: Get previous tag for release notes
        id: prev_tag
        run: |
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          PREV_TAG=$(git describe --tags --abbrev=0 ${LATEST_TAG}^)
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“ Previous tag: $PREV_TAG"

      - name: Generate release notes from commits
        id: release_notes
        run: |
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

          echo "Generating release notes from $PREV_TAG to $LATEST_TAG"

          # Get commit messages between tags
          COMMITS=$(git log ${PREV_TAG}..${LATEST_TAG} --pretty=format:"- %s" --no-merges)

          # Create release notes
          RELEASE_NOTES="## Changes in version ${{ steps.version.outputs.version }}

$COMMITS

**Full Changelog**: https://github.com/bceverly/wolfralyze/compare/${PREV_TAG}...${LATEST_TAG}"

          # Save to file and output
          echo "$RELEASE_NOTES" > release_notes.md
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "ðŸ“‹ Release notes generated"
          cat release_notes.md

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build plugin
        run: |
          ./gradlew clean build
          echo "âœ… Plugin built successfully"

      - name: Verify JAR exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          JAR_PATH="build/libs/wolfralyze-${VERSION}.jar"

          if [ ! -f "$JAR_PATH" ]; then
            echo "âŒ Error: JAR not found at $JAR_PATH"
            exit 1
          fi

          echo "âœ… JAR verified at $JAR_PATH"

      # Step 1: Update sonar-update-center-properties
      - name: Clone sonar-update-center-properties
        run: |
          git clone https://github.com/SonarSource/sonar-update-center-properties.git
          echo "âœ… Cloned sonar-update-center-properties"

      - name: Update wolfralyze.properties
        run: |
          cd sonar-update-center-properties
          VERSION="${{ steps.version.outputs.version }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
          TODAY=$(date +%Y-%m-%d)

          # Update the properties file
          PROPS_FILE="wolfralyze.properties"

          # Add new version to publicVersions (append to existing list)
          sed -i "s/publicVersions=\(.*\)/publicVersions=\1,$VERSION/" $PROPS_FILE

          # Add version-specific properties
          cat >> $PROPS_FILE << EOF

$VERSION.description=Bug fixes and improvements
$VERSION.sqs=[2025.1,LATEST]
$VERSION.sqcb=[24.12,LATEST]
$VERSION.downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar
$VERSION.changelogUrl=https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}
$VERSION.date=${TODAY}
EOF

          echo "âœ… Updated wolfralyze.properties"
          echo "ðŸ“„ Changes:"
          git diff $PROPS_FILE

      - name: Create PR for sonar-update-center-properties
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
        run: |
          cd sonar-update-center-properties
          VERSION="${{ steps.version.outputs.version }}"

          # Configure git with user's identity
          git config user.name "bceverly"
          git config user.email "${{ secrets.USER_EMAIL }}"

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add wolfralyze.properties
          git commit -m "Add wolfralyze ${VERSION}"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonar-update-center-properties.git
          git push fork $BRANCH

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonar-update-center-properties \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION}" \
            --body "Updates wolfralyze plugin to version ${VERSION}.

${{ steps.release_notes.outputs.release_notes }}

---
*This PR was automatically generated by the wolfralyze release workflow.*"

          echo "âœ… Created PR for sonar-update-center-properties"

      # Step 2: Update sonarqube-community-branch-plugin-builds
      - name: Clone sonarqube-community-branch-plugin-builds
        run: |
          git clone https://github.com/SonarSource/sonarqube-community-branch-plugin-builds.git
          echo "âœ… Cloned sonarqube-community-branch-plugin-builds"

      - name: Update build metadata
        run: |
          cd sonarqube-community-branch-plugin-builds
          VERSION="${{ steps.version.outputs.version }}"
          LATEST_TAG="${{ steps.version.outputs.latest_tag }}"

          # Create metadata file for the new version
          mkdir -p metadata/wolfralyze
          cat > metadata/wolfralyze/${VERSION}.json << EOF
{
  "version": "${VERSION}",
  "downloadUrl": "https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar",
  "changelogUrl": "https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}",
  "compatibleSQVersions": ["2025.1", "LATEST"],
  "date": "$(date +%Y-%m-%d)"
}
EOF

          echo "âœ… Created metadata file"
          cat metadata/wolfralyze/${VERSION}.json

      - name: Create PR for sonarqube-community-branch-plugin-builds
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
        run: |
          cd sonarqube-community-branch-plugin-builds
          VERSION="${{ steps.version.outputs.version }}"

          # Configure git with user's identity
          git config user.name "bceverly"
          git config user.email "${{ secrets.USER_EMAIL }}"

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add metadata/wolfralyze/${VERSION}.json
          git commit -m "Add wolfralyze ${VERSION} to marketplace"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonarqube-community-branch-plugin-builds.git
          git push fork $BRANCH

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonarqube-community-branch-plugin-builds \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION} to marketplace" \
            --body "Adds wolfralyze plugin version ${VERSION} to the SonarQube marketplace.

${{ steps.release_notes.outputs.release_notes }}

**Download URL:** https://github.com/bceverly/wolfralyze/releases/download/${{ steps.version.outputs.latest_tag }}/wolfralyze-${VERSION}.jar

---
*This PR was automatically generated by the wolfralyze release workflow.*"

          echo "âœ… Created PR for sonarqube-community-branch-plugin-builds"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "**Mode:** Dry run (no PRs created)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**PRs Created:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonar-update-center-properties" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonarqube-community-branch-plugin-builds" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          cat release_notes.md >> $GITHUB_STEP_SUMMARY
