name: Deploy New Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        type: boolean
        default: false

jobs:
  deploy-marketplace:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout wolfralyze
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          persist-credentials: false

      - name: Get latest tag and version info
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0)
          VERSION=${LATEST_TAG#v}  # Remove 'v' prefix if present

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Latest version: $VERSION (tag: $LATEST_TAG)"

      - name: Load release notes
        id: release_notes
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          if [ ! -f "RELEASE_NOTES.md" ]; then
            echo "âŒ Error: RELEASE_NOTES.md not found!"
            echo ""
            echo "Please run 'make release-notes' and commit the file before running this workflow."
            exit 1
          fi

          echo "ðŸ“‹ Extracting release notes for version ${VERSION} from RELEASE_NOTES.md"

          # Extract just the section for this version
          awk "/^## Version ${VERSION}\$/,/^## Version [0-9]/" RELEASE_NOTES.md | sed '$d' > current_release_notes.md

          # If extraction failed or file is empty, use a default message
          if [ ! -s current_release_notes.md ]; then
            echo "âš ï¸  Warning: Could not extract notes for version ${VERSION}, using default"
            echo "## Version ${VERSION}" > current_release_notes.md
            echo "" >> current_release_notes.md
            echo "See full release notes at: https://github.com/bceverly/wolfralyze/blob/master/RELEASE_NOTES.md" >> current_release_notes.md
          fi

          # Save to output
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat current_release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "Release notes for version ${VERSION}:"
          cat current_release_notes.md

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build plugin
        run: |
          ./gradlew clean build
          echo "âœ… Plugin built successfully"

      - name: Verify JAR exists
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          JAR_PATH="build/libs/wolfralyze-${VERSION}.jar"

          if [ ! -f "$JAR_PATH" ]; then
            echo "âŒ Error: JAR not found at $JAR_PATH"
            exit 1
          fi

          echo "âœ… JAR verified at $JAR_PATH"

      # Step 1: Update sonar-update-center-properties
      - name: Clone sonar-update-center-properties
        uses: actions/checkout@v4
        with:
          repository: SonarSource/sonar-update-center-properties
          path: sonar-update-center-properties
          persist-credentials: false

      - name: Update wolfralyze.properties
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
        run: |
          cd sonar-update-center-properties
          TODAY=$(date +%Y-%m-%d)

          # Update the properties file
          PROPS_FILE="wolfralyze.properties"

          # Add new version to publicVersions (append to existing list)
          sed -i "s/publicVersions=\(.*\)/publicVersions=\1,$VERSION/" $PROPS_FILE

          # Add version-specific properties
          echo "" >> $PROPS_FILE
          echo "$VERSION.description=Bug fixes and improvements" >> $PROPS_FILE
          echo "$VERSION.sqs=[2025.1,LATEST]" >> $PROPS_FILE
          echo "$VERSION.sqcb=[24.12,LATEST]" >> $PROPS_FILE
          echo "$VERSION.downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar" >> $PROPS_FILE
          echo "$VERSION.changelogUrl=https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}" >> $PROPS_FILE
          echo "$VERSION.date=${TODAY}" >> $PROPS_FILE

          echo "âœ… Updated wolfralyze.properties"
          echo "ðŸ“„ Changes:"
          git diff $PROPS_FILE

      - name: Create PR for sonar-update-center-properties
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonar-update-center-properties

          # Configure git with user's identity and credentials
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"
          git config --local credential.helper ""
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add wolfralyze.properties
          git commit -m "Add wolfralyze ${VERSION}"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonar-update-center-properties.git
          git push fork $BRANCH

          # Create PR body
          echo "Updates wolfralyze plugin to version ${VERSION}." > pr_body.txt
          echo "" >> pr_body.txt
          cat ../current_release_notes.md >> pr_body.txt
          echo "" >> pr_body.txt
          echo "---" >> pr_body.txt
          echo "*This PR was automatically generated by the wolfralyze release workflow.*" >> pr_body.txt

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonar-update-center-properties \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION}" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonar-update-center-properties"

      # Step 2: Add to sonarplugins.github.io
      - name: Clone sonarplugins.github.io
        uses: actions/checkout@v4
        with:
          repository: sonarplugins/sonarplugins.github.io
          path: sonarplugins.github.io
          persist-credentials: false

      - name: Create Jekyll post
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
        run: |
          cd sonarplugins.github.io

          TODAY=$(date +%Y-%m-%d)
          POST_FILE="_posts/${TODAY}-wolfralyze-${VERSION}.md"

          # Create Jekyll post with front matter
          cat > $POST_FILE << EOF
          ---
          layout: post
          title: Wolfralyze ${VERSION}
          date: ${TODAY}
          categories: plugin release
          tags: [mathematica, wolfram, code-quality]
          ---

          ## Wolfralyze ${VERSION} Released

          Professional Code Quality Analysis for Wolfram Mathematicaâ„¢

          **Version:** ${VERSION}
          **Download:** [wolfralyze-${VERSION}.jar](https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar)
          **Release Notes:** [View on GitHub](https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG})

          ### About Wolfralyze

          Wolfralyze is a Tier 1 SonarQubeÂ® plugin that brings enterprise-grade code quality analysis to Wolfram Mathematicaâ„¢. With 559 analysis rules, it provides the same depth of analysis available for mainstream languages like Java and Python.

          ### Release Highlights

          EOF

          # Append release notes content (skip the heading)
          tail -n +3 ../current_release_notes.md >> $POST_FILE

          echo "âœ… Created Jekyll post"
          echo "ðŸ“„ Post location: $POST_FILE"
          cat $POST_FILE

      - name: Create PR for sonarplugins.github.io
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonarplugins.github.io

          TODAY=$(date +%Y-%m-%d)
          POST_FILE="_posts/${TODAY}-wolfralyze-${VERSION}.md"

          # Configure git with user's identity and credentials
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"
          git config --local credential.helper ""
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add $POST_FILE
          git commit -m "Add wolfralyze ${VERSION} release post"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonarplugins.github.io.git
          git push fork $BRANCH

          # Create PR body
          echo "Adds wolfralyze plugin version ${VERSION} release announcement." > pr_body.txt
          echo "" >> pr_body.txt
          echo "**Plugin:** Wolfralyze - Professional Code Quality Analysis for Wolfram Mathematicaâ„¢" >> pr_body.txt
          echo "**Version:** ${VERSION}" >> pr_body.txt
          echo "" >> pr_body.txt
          cat ../current_release_notes.md >> pr_body.txt
          echo "" >> pr_body.txt
          echo "---" >> pr_body.txt
          echo "*This PR was automatically generated by the wolfralyze release workflow.*" >> pr_body.txt

          # Create PR using GitHub CLI
          gh pr create \
            --repo sonarplugins/sonarplugins.github.io \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION} release post" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonarplugins.github.io"

      - name: Summary
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.latest_tag }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          echo "## ðŸŽ‰ Release Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** $LATEST_TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DRY_RUN" == "true" ]; then
            echo "**Mode:** Dry run (no PRs created)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**PRs Created:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonar-update-center-properties" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… sonarplugins.github.io" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes for Version $VERSION" >> $GITHUB_STEP_SUMMARY
          cat current_release_notes.md >> $GITHUB_STEP_SUMMARY
