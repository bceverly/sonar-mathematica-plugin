name: Release Plugin

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Build and Release Plugin
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build plugin
        run: make build

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Find JAR file
        id: jar
        run: |
          JAR_FILE=$(ls build/libs/wolfralyze-*.jar)
          echo "file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Find SBOM file
        id: sbom
        run: |
          SBOM_FILE=$(ls build/reports/wolfralyze-*-sbom.json)
          echo "file=$SBOM_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $SBOM_FILE)" >> $GITHUB_OUTPUT

      - name: Generate SHA256 hash
        id: hash
        run: |
          HASH=$(sha256sum ${{ steps.jar.outputs.file }} | cut -d' ' -f1)
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      - name: Generate SBOM SHA256 hash
        id: sbomhash
        run: |
          HASH=$(sha256sum ${{ steps.sbom.outputs.file }} | cut -d' ' -f1)
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      - name: Generate SonarSource update-center properties
        id: marketplace
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}
          DATE=$(date -u +"%Y-%m-%d")

          cat > update-center-properties <<EOF
          # Plugin metadata for SonarQube Marketplace
          # Auto-generated from git tag: $TAG

          # Display name in marketplace
          name=Wolfram Mathematica

          # Short description (max 100 chars)
          description=Code quality and security analysis for Wolfram Mathematica with 529+ rules

          # Version number
          version=$VERSION

          # Download URL for the JAR (GitHub release)
          downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/$TAG/wolfralyze-$VERSION.jar

          # Compatible SonarQube versions
          sqVersions=[9.0,LATEST]

          # Date of this version (format: yyyy-MM-dd)
          date=$DATE

          # Organization
          organization=Bryan C. Everly
          organizationUrl=https://github.com/bceverly

          # Developers
          developers=Bryan C. Everly

          # Homepage
          homepageUrl=https://github.com/bceverly/wolfralyze

          # Issue tracker
          issueTrackerUrl=https://github.com/bceverly/wolfralyze/issues

          # License
          license=GNU LGPL 3

          # Category
          category=Languages
          EOF

          echo "file=update-center-properties" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > release_notes.md <<'EOF'
          ## SonarQube Mathematica Plugin ${{ steps.version.outputs.version }}

          ### Installation Instructions

          1. **Download the plugin JAR:**
             - Download `${{ steps.jar.outputs.name }}` from the assets below

          2. **Verify the download (optional but recommended):**
             ```bash
             sha256sum ${{ steps.jar.outputs.name }}
             ```
             Expected hash: `${{ steps.hash.outputs.sha256 }}`

             **SBOM Verification:**
             ```bash
             sha256sum ${{ steps.sbom.outputs.name }}
             ```
             Expected hash: `${{ steps.sbomhash.outputs.sha256 }}`

          3. **Install to SonarQube:**
             ```bash
             # Copy JAR to SonarQube plugins directory
             cp ${{ steps.jar.outputs.name }} $SONARQUBE_HOME/extensions/plugins/

             # Remove old versions (if any)
             rm -f $SONARQUBE_HOME/extensions/plugins/wolfralyze-*.jar
             # (Keep only the new version you just copied)
             ```

          4. **Restart SonarQube:**
             ```bash
             # macOS:
             $SONARQUBE_HOME/bin/macosx-universal-64/sonar.sh restart

             # Linux:
             $SONARQUBE_HOME/bin/linux-x86-64/sonar.sh restart

             # Windows:
             # Use Services control panel or:
             # $SONARQUBE_HOME\bin\windows-x86-64\StopNTService.bat
             # $SONARQUBE_HOME\bin\windows-x86-64\StartNTService.bat
             ```

          5. **Verify installation:**
             - Navigate to: Administration â†’ Marketplace â†’ Installed
             - Look for "Mathematica" plugin
             - Version should show: ${{ steps.version.outputs.version }}

          ### Plugin Details

          - **Version:** ${{ steps.version.outputs.version }}
          - **JAR File:** `${{ steps.jar.outputs.name }}`
          - **JAR SHA256:** `${{ steps.hash.outputs.sha256 }}`
          - **SBOM File:** `${{ steps.sbom.outputs.name }}`
          - **SBOM SHA256:** `${{ steps.sbomhash.outputs.sha256 }}`
          - **Marketplace Properties:** `update-center-properties` (for SonarSource marketplace submission)
          - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Minimum SonarQube Version:** 9.9

          ### Features

          - Support for Wolfram Mathematica code analysis (.m, .wl, .wls files)
          - 430+ code quality rules
          - Security vulnerability detection (21 rules)
          - Security hotspot detection (7 rules)
          - Bug detection (80+ rules)
          - Code smell detection (300+ rules)
          - Symbol table analysis for variable lifetime and scope
          - Copy-paste detection (CPD)
          - Syntax highlighting
          - Metrics: Lines of code, cyclomatic complexity, cognitive complexity

          ### Configuration

          Add to your `sonar-project.properties`:
          ```properties
          # Enable Mathematica analysis
          sonar.mathematica.file.suffixes=.m,.wl,.wls
          ```

          For more configuration options, see the project documentation.

          ---

          ðŸ¤– Generated with GitHub Actions
          EOF

          echo "file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            ${{ steps.jar.outputs.file }}
            ${{ steps.sbom.outputs.file }}
            ${{ steps.marketplace.outputs.file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
