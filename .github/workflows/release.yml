name: Release Plugin

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Build and Release Plugin
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build plugin
        run: make build

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Find JAR file
        id: jar
        run: |
          JAR_FILE=$(ls build/libs/wolfralyze-*.jar)
          echo "file=$JAR_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT

      - name: Find SBOM file
        id: sbom
        run: |
          SBOM_FILE=$(ls build/reports/wolfralyze-*-sbom.json)
          echo "file=$SBOM_FILE" >> $GITHUB_OUTPUT
          echo "name=$(basename $SBOM_FILE)" >> $GITHUB_OUTPUT

      - name: Generate SHA256 hash
        id: hash
        run: |
          HASH=$(sha256sum ${{ steps.jar.outputs.file }} | cut -d' ' -f1)
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      - name: Generate SBOM SHA256 hash
        id: sbomhash
        run: |
          HASH=$(sha256sum ${{ steps.sbom.outputs.file }} | cut -d' ' -f1)
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      - name: Generate SonarSource update-center properties
        id: marketplace
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}
          DATE=$(date -u +"%Y-%m-%d")

          cat > update-center-properties <<EOF
          # Plugin metadata for SonarQube Marketplace
          # Auto-generated from git tag: $TAG

          # Display name in marketplace
          name=Wolfram Mathematica

          # Short description (max 100 chars)
          description=Code quality and security analysis for Wolfram Mathematica with 529+ rules

          # Version number
          version=$VERSION

          # Download URL for the JAR (GitHub release)
          downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/$TAG/wolfralyze-$VERSION.jar

          # Compatible SonarQube versions
          sqVersions=[9.0,LATEST]

          # Date of this version (format: yyyy-MM-dd)
          date=$DATE

          # Organization
          organization=Bryan C. Everly
          organizationUrl=https://github.com/bceverly

          # Developers
          developers=Bryan C. Everly

          # Homepage
          homepageUrl=https://wolfralyze.org

          # Issue tracker
          issueTrackerUrl=https://github.com/bceverly/wolfralyze/issues

          # License
          license=AGPL-3.0

          # Category
          category=Languages
          EOF

          echo "file=update-center-properties" >> $GITHUB_OUTPUT

      - name: Create release notes
        id: notes
        run: |
          cat > release_notes.md <<'EOF'
          ## Wolfralyze - SonarQube Mathematica Plugin ${{ steps.version.outputs.version }}

          ### Installation Instructions

          1. **Download the plugin JAR:**
             - Download `${{ steps.jar.outputs.name }}` from the assets below

          2. **Verify the download (optional but recommended):**
             ```bash
             sha256sum ${{ steps.jar.outputs.name }}
             ```
             Expected hash: `${{ steps.hash.outputs.sha256 }}`

             **SBOM Verification:**
             ```bash
             sha256sum ${{ steps.sbom.outputs.name }}
             ```
             Expected hash: `${{ steps.sbomhash.outputs.sha256 }}`

          3. **Install to SonarQube:**
             ```bash
             # Copy JAR to SonarQube plugins directory
             cp ${{ steps.jar.outputs.name }} $SONARQUBE_HOME/extensions/plugins/

             # Remove old versions (if any)
             rm -f $SONARQUBE_HOME/extensions/plugins/wolfralyze-*.jar
             # (Keep only the new version you just copied)
             ```

          4. **Restart SonarQube:**
             ```bash
             # macOS:
             $SONARQUBE_HOME/bin/macosx-universal-64/sonar.sh restart

             # Linux:
             $SONARQUBE_HOME/bin/linux-x86-64/sonar.sh restart

             # Windows:
             # Use Services control panel or:
             # $SONARQUBE_HOME\bin\windows-x86-64\StopNTService.bat
             # $SONARQUBE_HOME\bin\windows-x86-64\StartNTService.bat
             ```

          5. **Verify installation:**
             - Navigate to: Administration â†’ Marketplace â†’ Installed
             - Look for "Mathematica" plugin (Wolfralyze)
             - Version should show: ${{ steps.version.outputs.version }}

          ### Plugin Details

          - **Version:** ${{ steps.version.outputs.version }}
          - **JAR File:** `${{ steps.jar.outputs.name }}`
          - **JAR SHA256:** `${{ steps.hash.outputs.sha256 }}`
          - **SBOM File:** `${{ steps.sbom.outputs.name }}`
          - **SBOM SHA256:** `${{ steps.sbomhash.outputs.sha256 }}`
          - **Marketplace Properties:** `update-center-properties` (for SonarSource marketplace submission)
          - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Minimum SonarQube Version:** 9.9

          ### Features

          - Support for Wolfram Mathematica code analysis (.m, .wl, .wls files)
          - 430+ code quality rules
          - Security vulnerability detection (21 rules)
          - Security hotspot detection (7 rules)
          - Bug detection (80+ rules)
          - Code smell detection (300+ rules)
          - Symbol table analysis for variable lifetime and scope
          - Copy-paste detection (CPD)
          - Syntax highlighting
          - Metrics: Lines of code, cyclomatic complexity, cognitive complexity

          ### Configuration

          Add to your `sonar-project.properties`:
          ```properties
          # Enable Mathematica analysis
          sonar.mathematica.file.suffixes=.m,.wl,.wls
          ```

          For more configuration options, see the [project documentation](https://wolfralyze.org).

          ---

          ðŸ¤– Generated with GitHub Actions
          EOF

          echo "file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            ${{ steps.jar.outputs.file }}
            ${{ steps.sbom.outputs.file }}
            ${{ steps.marketplace.outputs.file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Marketplace Deployment Steps
      - name: Clone sonar-update-center-properties
        uses: actions/checkout@v4
        with:
          repository: SonarSource/sonar-update-center-properties
          path: sonar-update-center-properties
          persist-credentials: false

      - name: Update wolfralyze.properties
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.tag }}
        run: |
          cd sonar-update-center-properties
          TODAY=$(date +%Y-%m-%d)
          PROPS_FILE="wolfralyze.properties"

          # Get current year and month for wildcards
          CURRENT_YEAR=$(date +%Y)
          CURRENT_MONTH=$(date +%-m)

          # Step 1: Find all versions currently using LATEST and replace with wildcards
          # This ensures only ONE version ever targets LATEST (per SonarSource rules)
          sed -i.bak "s/\.sqs=\[\([^,]*\),LATEST\]/.sqs=[\1,${CURRENT_YEAR}.*]/g" $PROPS_FILE
          sed -i.bak "s/\.sqcb=\[\([^,]*\),LATEST\]/.sqcb=[\1,${CURRENT_YEAR}.${CURRENT_MONTH}.*]/g" $PROPS_FILE

          # Step 2: Move current publicVersions to archivedVersions
          PREV_VERSIONS=$(grep "^publicVersions=" $PROPS_FILE | sed 's/publicVersions=//')
          if [ ! -z "$PREV_VERSIONS" ]; then
            # Update archivedVersions line if it exists, or create it
            if grep -q "^archivedVersions=" $PROPS_FILE; then
              # Append to existing archivedVersions
              sed -i.bak "s/^archivedVersions=\(.*\)/archivedVersions=\1,$PREV_VERSIONS/" $PROPS_FILE
            else
              # Insert archivedVersions after publicVersions line using a temp file
              awk -v prev="$PREV_VERSIONS" '/^publicVersions=/ {print; print "archivedVersions=" prev; next} {print}' $PROPS_FILE > ${PROPS_FILE}.tmp
              mv ${PROPS_FILE}.tmp $PROPS_FILE
            fi
          fi

          # Step 3: Replace publicVersions with ONLY the new version
          sed -i.bak "s/^publicVersions=.*/publicVersions=$VERSION/" $PROPS_FILE

          # Step 4: Add version-specific properties for NEW version with LATEST
          echo "" >> $PROPS_FILE
          echo "$VERSION.description=Bug fixes and improvements" >> $PROPS_FILE
          echo "$VERSION.sqs=[2025.1,LATEST]" >> $PROPS_FILE
          echo "$VERSION.sqcb=[24.12,LATEST]" >> $PROPS_FILE
          echo "$VERSION.downloadUrl=https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar" >> $PROPS_FILE
          echo "$VERSION.changelogUrl=https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}" >> $PROPS_FILE
          echo "$VERSION.date=${TODAY}" >> $PROPS_FILE

          # Clean up backup files
          rm -f $PROPS_FILE.bak

          echo "âœ… Updated wolfralyze.properties"
          echo "ðŸ“„ Changes:"
          git diff $PROPS_FILE

      - name: Create PR for sonar-update-center-properties
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.tag }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonar-update-center-properties

          # Configure git with user's identity and credentials
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"
          git config --local credential.helper ""
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add wolfralyze.properties
          git commit -m "Add wolfralyze ${VERSION}"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonar-update-center-properties.git
          git push fork $BRANCH

          # Create PR body (following approved SonarDelphi format)
          cat > pr_body.txt << EOF
          Release Wolfralyze v${VERSION}

          - Release notes: https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}
          - SonarCloud: https://sonarcloud.io/summary/new_code?id=bceverly_wolfralyze
          - Add to the marketplace

          Thanks!
          EOF

          # Create PR using GitHub CLI
          gh pr create \
            --repo SonarSource/sonar-update-center-properties \
            --head bceverly:$BRANCH \
            --title "Release Wolfralyze v${VERSION}" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonar-update-center-properties"

      - name: Clone sonarplugins.github.io
        uses: actions/checkout@v4
        with:
          repository: sonarplugins/sonarplugins.github.io
          path: sonarplugins.github.io
          persist-credentials: false

      - name: Create Jekyll post
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.tag }}
        run: |
          cd sonarplugins.github.io

          TODAY=$(date +%Y-%m-%d)
          POST_FILE="_posts/${TODAY}-wolfralyze-${VERSION}.md"

          # Create Jekyll post with front matter
          cat > $POST_FILE << EOF
          ---
          layout: post
          title: Wolfralyze ${VERSION}
          date: ${TODAY}
          categories: plugin release
          tags: [mathematica, wolfram, code-quality]
          ---

          ## Wolfralyze ${VERSION} Released

          Professional Code Quality Analysis for Wolfram Mathematicaâ„¢

          **Version:** ${VERSION}
          **Download:** [wolfralyze-${VERSION}.jar](https://github.com/bceverly/wolfralyze/releases/download/${LATEST_TAG}/wolfralyze-${VERSION}.jar)
          **Release Notes:** [View on GitHub](https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG})

          ### About Wolfralyze

          Wolfralyze is a Tier 1 SonarQubeÂ® plugin that brings enterprise-grade code quality analysis to Wolfram Mathematicaâ„¢. With 559 analysis rules, it provides the same depth of analysis available for mainstream languages like Java and Python.

          ### Release Highlights

          See full release notes on GitHub for details.
          EOF

          echo "âœ… Created Jekyll post"
          echo "ðŸ“„ Post location: $POST_FILE"

      - name: Create PR for sonarplugins.github.io
        env:
          GH_TOKEN: ${{ secrets.SONAR_MARKETPLACE_PAT }}
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.tag }}
          USER_EMAIL: ${{ secrets.USER_EMAIL }}
        run: |
          cd sonarplugins.github.io

          TODAY=$(date +%Y-%m-%d)
          POST_FILE="_posts/${TODAY}-wolfralyze-${VERSION}.md"

          # Configure git with user's identity and credentials
          git config user.name "bceverly"
          git config user.email "$USER_EMAIL"
          git config --local credential.helper ""
          git config --local --unset-all http.https://github.com/.extraheader || true

          # Create branch and commit
          BRANCH="wolfralyze-${VERSION}"
          git checkout -b $BRANCH
          git add $POST_FILE
          git commit -m "Add wolfralyze ${VERSION} release post"

          # Push to fork (user must fork the repo first)
          git remote add fork https://x-access-token:${GH_TOKEN}@github.com/bceverly/sonarplugins.github.io.git
          git push fork $BRANCH

          # Create PR body
          cat > pr_body.txt << EOF
          Release Wolfralyze v${VERSION}

          - Release notes: https://github.com/bceverly/wolfralyze/releases/tag/${LATEST_TAG}
          - SonarCloud: https://sonarcloud.io/summary/new_code?id=bceverly_wolfralyze
          - Add to the marketplace

          Thanks!
          EOF

          # Create PR using GitHub CLI
          gh pr create \
            --repo sonarplugins/sonarplugins.github.io \
            --head bceverly:$BRANCH \
            --title "Add wolfralyze ${VERSION} release post" \
            --body-file pr_body.txt

          echo "âœ… Created PR for sonarplugins.github.io"

      - name: Deployment Summary
        env:
          VERSION: ${{ steps.version.outputs.version }}
          LATEST_TAG: ${{ steps.version.outputs.tag }}
        run: |
          echo "## ðŸŽ‰ Release Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** $LATEST_TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Actions Completed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Built plugin JAR" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Created GitHub release" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Created PR to sonar-update-center-properties" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Created PR to sonarplugins.github.io" >> $GITHUB_STEP_SUMMARY
