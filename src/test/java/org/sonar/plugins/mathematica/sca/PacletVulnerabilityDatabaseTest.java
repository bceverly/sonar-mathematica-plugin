package org.sonar.plugins.mathematica.sca;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;
import org.sonar.api.issue.impact.Severity;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

class PacletVulnerabilityDatabaseTest {

    @Test
    void testCheckDependencyWithKnownVulnerability() {
        PacletDependency dep = new PacletDependency("HTTPClient", "1.5", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getIdentifier()).isEqualTo("DEPRECATED-001");
        assertThat(vulns.get(0).getSeverity()).isEqualTo(Severity.HIGH);
    }

    @ParameterizedTest
    @CsvSource({
        "HTTPClient, 2.0",
        "HTTPClient, 2.1+",
        "HTTPClient, 100.0",
        "NonExistentPaclet, 1.0",
        "FileUtilities, 1.4",
        "FileUtilities, 0.9",
        "CryptoUtils, 1.5+"
    })
    void testCheckDependencyWithSafeVersions(String pacletName, String version) {
        PacletDependency dep = new PacletDependency(pacletName, version, 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isEmpty();
    }

    @Test
    void testCheckDependencyWithUnknownVersion() {
        PacletDependency dep = new PacletDependency("HTTPClient", "unknown", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getIdentifier()).isEqualTo("DEPRECATED-001");
    }

    @Test
    void testCheckDependencyCryptoUtils() {
        PacletDependency dep = new PacletDependency("CryptoUtils", "1.2", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getIdentifier()).isEqualTo("CVE-MATHEMATICA-2020-001");
        assertThat(vulns.get(0).getSeverity()).isEqualTo(Severity.MEDIUM);
    }

    @Test
    void testCheckDependencyDatabaseLink() {
        PacletDependency dep = new PacletDependency("DatabaseLink", "8.5", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getIdentifier()).isEqualTo("SECURITY-003");
        assertThat(vulns.get(0).getDescription()).contains("SQL injection");
    }

    @Test
    void testCheckDependencyNeuralNetworks() {
        PacletDependency dep = new PacletDependency("NeuralNetworks", "11.0", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getSeverity()).isEqualTo(Severity.LOW);
        assertThat(vulns.get(0).getDescription()).contains("deprecated");
    }

    @Test
    void testCheckDependencyFileUtilitiesInRange() {
        PacletDependency dep = new PacletDependency("FileUtilities", "1.2", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getIdentifier()).isEqualTo("CVE-MATHEMATICA-2021-005");
        assertThat(vulns.get(0).getDescription()).contains("Path traversal");
    }

    @Test
    void testCheckDependencyFileUtilitiesOutsideRange() {
        PacletDependency dep = new PacletDependency("FileUtilities", "1.4", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isEmpty();
    }

    @Test
    void testCheckDependencyCloudDeploy() {
        PacletDependency dep = new PacletDependency("CloudDeploy", "10.5", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        assertThat(vulns.get(0).getRemediation()).contains("11.0+");
    }

    @ParameterizedTest
    @CsvSource({
        "HTTPClient, 1.9",
        "HTTPClient, 1.9.9",
        "HTTPClient, 1.5.3",
        "HTTPClient, 1.9beta",
        "HTTPClient, 0.9"
    })
    void testHttpClientVulnerableVersions(String pacletName, String version) {
        PacletDependency dep = new PacletDependency(pacletName, version, 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
    }

    @Test
    void testVersionRange() {
        PacletDependency depMin = new PacletDependency("FileUtilities", "1.0", 1);
        PacletDependency depMid = new PacletDependency("FileUtilities", "1.2", 1);
        PacletDependency depMax = new PacletDependency("FileUtilities", "1.3", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulnsMin =
            PacletVulnerabilityDatabase.checkDependency(depMin);
        List<PacletVulnerabilityDatabase.Vulnerability> vulnsMid =
            PacletVulnerabilityDatabase.checkDependency(depMid);
        List<PacletVulnerabilityDatabase.Vulnerability> vulnsMax =
            PacletVulnerabilityDatabase.checkDependency(depMax);

        assertThat(vulnsMin).isNotEmpty();
        assertThat(vulnsMid).isNotEmpty();
        assertThat(vulnsMax).isNotEmpty();
    }

    @Test
    void testVersionOutsideRange() {
        PacletDependency depBefore = new PacletDependency("FileUtilities", "0.9", 1);
        PacletDependency depAfter = new PacletDependency("FileUtilities", "1.4", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulnsBefore =
            PacletVulnerabilityDatabase.checkDependency(depBefore);
        List<PacletVulnerabilityDatabase.Vulnerability> vulnsAfter =
            PacletVulnerabilityDatabase.checkDependency(depAfter);

        assertThat(vulnsBefore).isEmpty();
        assertThat(vulnsAfter).isEmpty();
    }

    @Test
    void testVulnerabilityGetters() {
        PacletDependency dep = new PacletDependency("HTTPClient", "1.0", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        PacletVulnerabilityDatabase.Vulnerability vuln = vulns.get(0);

        assertThat(vuln.getIdentifier()).isNotNull();
        assertThat(vuln.getDescription()).isNotNull();
        assertThat(vuln.getSeverity()).isNotNull();
        assertThat(vuln.getAffectedVersions()).isNotNull();
        assertThat(vuln.getRemediation()).isNotNull();
    }

    @Test
    void testVulnerabilityDetails() {
        PacletDependency dep = new PacletDependency("CryptoUtils", "1.0", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
        PacletVulnerabilityDatabase.Vulnerability vuln = vulns.get(0);

        assertThat(vuln.getDescription()).contains("weak encryption");
        assertThat(vuln.getAffectedVersions()).isEqualTo("< 1.5");
        assertThat(vuln.getRemediation()).contains("1.5+");
    }

    @Test
    void testVersionComparisonEdgeCases() {
        PacletDependency dep1 = new PacletDependency("HTTPClient", "2.0.0", 1);
        PacletDependency dep2 = new PacletDependency("HTTPClient", "2", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns1 =
            PacletVulnerabilityDatabase.checkDependency(dep1);
        List<PacletVulnerabilityDatabase.Vulnerability> vulns2 =
            PacletVulnerabilityDatabase.checkDependency(dep2);

        assertThat(vulns1).isEmpty();
        assertThat(vulns2).isEmpty();
    }

    @Test
    void testMultipleVulnerabilitiesForSamePaclet() {
        PacletDependency dep = new PacletDependency("HTTPClient", "1.0", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> vulns =
            PacletVulnerabilityDatabase.checkDependency(dep);

        assertThat(vulns).isNotEmpty();
    }

    @Test
    void testVulnerabilitySeverityTypes() {
        PacletDependency httpClient = new PacletDependency("HTTPClient", "1.0", 1);
        PacletDependency cryptoUtils = new PacletDependency("CryptoUtils", "1.0", 1);
        PacletDependency neuralNets = new PacletDependency("NeuralNetworks", "10.0", 1);

        List<PacletVulnerabilityDatabase.Vulnerability> httpVulns =
            PacletVulnerabilityDatabase.checkDependency(httpClient);
        List<PacletVulnerabilityDatabase.Vulnerability> cryptoVulns =
            PacletVulnerabilityDatabase.checkDependency(cryptoUtils);
        List<PacletVulnerabilityDatabase.Vulnerability> neuralVulns =
            PacletVulnerabilityDatabase.checkDependency(neuralNets);

        assertThat(httpVulns.get(0).getSeverity()).isEqualTo(Severity.HIGH);
        assertThat(cryptoVulns.get(0).getSeverity()).isEqualTo(Severity.MEDIUM);
        assertThat(neuralVulns.get(0).getSeverity()).isEqualTo(Severity.LOW);
    }

    @Test
    void testAllKnownVulnerabilities() {
        PacletDependency httpClient = new PacletDependency("HTTPClient", "1.0", 1);
        PacletDependency cryptoUtils = new PacletDependency("CryptoUtils", "1.0", 1);
        PacletDependency databaseLink = new PacletDependency("DatabaseLink", "8.0", 1);
        PacletDependency neuralNetworks = new PacletDependency("NeuralNetworks", "10.0", 1);
        PacletDependency fileUtilities = new PacletDependency("FileUtilities", "1.1", 1);
        PacletDependency cloudDeploy = new PacletDependency("CloudDeploy", "10.0", 1);

        assertThat(PacletVulnerabilityDatabase.checkDependency(httpClient)).isNotEmpty();
        assertThat(PacletVulnerabilityDatabase.checkDependency(cryptoUtils)).isNotEmpty();
        assertThat(PacletVulnerabilityDatabase.checkDependency(databaseLink)).isNotEmpty();
        assertThat(PacletVulnerabilityDatabase.checkDependency(neuralNetworks)).isNotEmpty();
        assertThat(PacletVulnerabilityDatabase.checkDependency(fileUtilities)).isNotEmpty();
        assertThat(PacletVulnerabilityDatabase.checkDependency(cloudDeploy)).isNotEmpty();
    }
}
