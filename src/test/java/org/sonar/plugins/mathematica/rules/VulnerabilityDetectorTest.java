package org.sonar.plugins.mathematica.rules;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sonar.api.batch.fs.InputFile;
import org.sonar.api.batch.sensor.SensorContext;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class VulnerabilityDetectorTest {

    private VulnerabilityDetector detector;
    private SensorContext context;
    private InputFile inputFile;

    @BeforeEach
    void setUp() {
        detector = new VulnerabilityDetector();
        context = mock(SensorContext.class);
        inputFile = mock(InputFile.class);

        when(inputFile.filename()).thenReturn("test.m");
    }

    // ===== INJECTION VULNERABILITY TESTS =====

    @Test
    void testDetectHardcodedCredentials() {
        String content = "password = \"mySecretPassword123\";";
        assertDoesNotThrow(() ->
            detector.detectHardcodedCredentials(context, inputFile, content)
        );
    }

    @Test
    void testDetectCommandInjection() {
        String content = "Run[\"rm -rf \" <> userInput];";
        assertDoesNotThrow(() ->
            detector.detectCommandInjection(context, inputFile, content)
        );
    }

    @Test
    void testDetectSqlInjection() {
        String content = "SQLExecute[conn, \"SELECT * FROM users WHERE name='\" <> userName <> \"'\"];";
        assertDoesNotThrow(() ->
            detector.detectSqlInjection(context, inputFile, content)
        );
    }

    @Test
    void testDetectCodeInjection() {
        String content = "ToExpression[userInput];";
        assertDoesNotThrow(() ->
            detector.detectCodeInjection(context, inputFile, content)
        );
    }

    @Test
    void testDetectPathTraversal() {
        String content = "Import[\"/path/to/\" <> fileName];";
        assertDoesNotThrow(() ->
            detector.detectPathTraversal(context, inputFile, content)
        );
    }

    // ===== CRYPTOGRAPHY VULNERABILITY TESTS =====

    @Test
    void testDetectWeakCryptography() {
        String content = "Hash[data, \"MD5\"];";
        assertDoesNotThrow(() ->
            detector.detectWeakCryptography(context, inputFile, content)
        );
    }

    @Test
    void testDetectInsecureRandomExpanded() {
        String content = "Random[];";
        assertDoesNotThrow(() ->
            detector.detectInsecureRandomExpanded(context, inputFile, content)
        );
    }

    @Test
    void testDetectHardcodedApiKeys() {
        String content = "\"APIKey\" -> \"abcdef1234567890123456789012345678901234\";";
        assertDoesNotThrow(() ->
            detector.detectHardcodedApiKeys(context, inputFile, content)
        );
    }

    // ===== NETWORK VULNERABILITY TESTS =====

    @Test
    void testDetectSsrf() {
        String content = "URLFetch[\"http://\" <> serverAddress];";
        assertDoesNotThrow(() ->
            detector.detectSsrf(context, inputFile, content)
        );
    }

    @Test
    void testDetectXXE() {
        String content = "Import[xmlFile, \"XML\"];";
        assertDoesNotThrow(() ->
            detector.detectXXE(context, inputFile, content)
        );
    }

    // ===== DESERIALIZATION VULNERABILITY TESTS =====

    @Test
    void testDetectInsecureDeserialization() {
        String content = "Import[untrustedFile, \"MX\"];";
        assertDoesNotThrow(() ->
            detector.detectInsecureDeserialization(context, inputFile, content)
        );
    }

    @Test
    void testDetectUnsafeSymbol() {
        String content = "Symbol[userInput];";
        assertDoesNotThrow(() ->
            detector.detectUnsafeSymbol(context, inputFile, content)
        );
    }

    // ===== INPUT VALIDATION TESTS =====

    @Test
    void testDetectMissingSanitization() {
        String content = "RunProcess[{\"sh\", userCommand}];";
        assertDoesNotThrow(() ->
            detector.detectMissingSanitization(context, inputFile, content)
        );
    }

    @Test
    void testDetectToExpressionOnInput() {
        String content = "result = ToExpression[userInput];";
        assertDoesNotThrow(() ->
            detector.detectToExpressionOnInput(context, inputFile, content)
        );
    }

    @Test
    void testDetectUnsanitizedRunProcess() {
        String content = "RunProcess[command];";
        assertDoesNotThrow(() ->
            detector.detectUnsanitizedRunProcess(context, inputFile, content)
        );
    }

    @Test
    void testDetectNeedsGetUntrusted() {
        String content = "Needs[packageName];";
        assertDoesNotThrow(() ->
            detector.detectNeedsGetUntrusted(context, inputFile, content)
        );
    }

    @Test
    void testDetectMissingFormFunctionValidation() {
        String content = "FormFunction[{\"name\" -> \"String\"}];";
        assertDoesNotThrow(() ->
            detector.detectMissingFormFunctionValidation(context, inputFile, content)
        );
    }

    // ===== CLOUD/API SECURITY TESTS =====

    @Test
    void testDetectUnsafeCloudDeploy() {
        String content = "CloudDeploy[APIFunction[func]];";
        assertDoesNotThrow(() ->
            detector.detectUnsafeCloudDeploy(context, inputFile, content)
        );
    }

    @Test
    void testDetectMissingCloudAuth() {
        String content = "CloudDeploy[notebook];";
        assertDoesNotThrow(() ->
            detector.detectMissingCloudAuth(context, inputFile, content)
        );
    }

    @Test
    void testDetectExposingSensitiveData() {
        String content = "CloudDeploy[sensitiveData];";
        assertDoesNotThrow(() ->
            detector.detectExposingSensitiveData(context, inputFile, content)
        );
    }

    @Test
    void testDetectDynamicInjection() {
        String content = "Dynamic[ToExpression[input]];";
        assertDoesNotThrow(() ->
            detector.detectDynamicInjection(context, inputFile, content)
        );
    }

    // ===== COMPREHENSIVE TESTS =====

    @Test
    void testAllInjectionMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectHardcodedCredentials(context, inputFile, content);
            detector.detectCommandInjection(context, inputFile, content);
            detector.detectSqlInjection(context, inputFile, content);
            detector.detectCodeInjection(context, inputFile, content);
            detector.detectPathTraversal(context, inputFile, content);
        });
    }

    @Test
    void testAllCryptographyMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectWeakCryptography(context, inputFile, content);
            detector.detectInsecureRandomExpanded(context, inputFile, content);
            detector.detectHardcodedApiKeys(context, inputFile, content);
        });
    }

    @Test
    void testAllNetworkMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectSsrf(context, inputFile, content);
            detector.detectXXE(context, inputFile, content);
        });
    }

    @Test
    void testAllDeserializationMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectInsecureDeserialization(context, inputFile, content);
            detector.detectUnsafeSymbol(context, inputFile, content);
        });
    }

    @Test
    void testAllValidationMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectMissingSanitization(context, inputFile, content);
            detector.detectToExpressionOnInput(context, inputFile, content);
            detector.detectUnsanitizedRunProcess(context, inputFile, content);
            detector.detectNeedsGetUntrusted(context, inputFile, content);
            detector.detectMissingFormFunctionValidation(context, inputFile, content);
        });
    }

    @Test
    void testAllCloudMethodsWithEmptyContent() {
        String content = "";

        assertDoesNotThrow(() -> {
            detector.detectUnsafeCloudDeploy(context, inputFile, content);
            detector.detectMissingCloudAuth(context, inputFile, content);
            detector.detectExposingSensitiveData(context, inputFile, content);
            detector.detectDynamicInjection(context, inputFile, content);
        });
    }

    @Test
    void testComplexCodeWithMultipleVulnerabilities() {
        String content = "password = \"hardcoded123\";\n"
                + "Run[\"rm -rf \" <> userInput];\n"
                + "ToExpression[untrustedData];\n"
                + "Hash[secret, \"MD5\"];\n"
                + "CloudDeploy[APIFunction[func]];";

        assertDoesNotThrow(() -> {
            detector.detectHardcodedCredentials(context, inputFile, content);
            detector.detectCommandInjection(context, inputFile, content);
            detector.detectCodeInjection(context, inputFile, content);
            detector.detectWeakCryptography(context, inputFile, content);
            detector.detectUnsafeCloudDeploy(context, inputFile, content);
        });
    }

    @Test
    void testSecureCodeWithNoVulnerabilities() {
        String content = "password = Environment[\"PASSWORD\"];\n"
                + "cmd = StringReplace[userInput, {\";\"|\"|\"|\"&\"} -> \"\"];\n"
                + "RunProcess[{\"safe\", cmd}];\n"
                + "Hash[data, \"SHA256\"];\n"
                + "authenticated = CloudConnect[];";

        assertDoesNotThrow(() -> {
            detector.detectHardcodedCredentials(context, inputFile, content);
            detector.detectCommandInjection(context, inputFile, content);
            detector.detectWeakCryptography(context, inputFile, content);
        });
    }

    @Test
    void testLargeFileSkipping() {
        // Create very long content to test file size limiting
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 60000; i++) {
            sb.append("line ").append(i).append(";\n");
        }
        String content = sb.toString();

        assertDoesNotThrow(() -> {
            detector.detectHardcodedCredentials(context, inputFile, content);
            detector.detectCommandInjection(context, inputFile, content);
        });
    }

    @Test
    void testMultipleHardcodedCredentials() {
        String content = "apiKey = \"1234567890abcdefghijklmnopqrstuvwxyz\";\n"
                + "secretKey = \"mysecretkey123\";\n"
                + "token = \"Bearer abc123def456\";";

        assertDoesNotThrow(() ->
            detector.detectHardcodedCredentials(context, inputFile, content)
        );
    }

    @Test
    void testVariousInjectionPatterns() {
        String content = "SQLExecute[conn, \"SELECT * FROM \" <> table];\n"
                + "Import[\"/base/\" <> userFile];\n"
                + "URLFetch[\"http://\" <> host];\n"
                + "Symbol[varName];";

        assertDoesNotThrow(() -> {
            detector.detectSqlInjection(context, inputFile, content);
            detector.detectPathTraversal(context, inputFile, content);
            detector.detectSsrf(context, inputFile, content);
            detector.detectUnsafeSymbol(context, inputFile, content);
        });
    }
}
