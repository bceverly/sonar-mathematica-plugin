package org.sonar.plugins.mathematica.rules;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sonar.api.batch.fs.InputFile;
import org.sonar.api.batch.sensor.SensorContext;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class VulnerabilityDetectorAstTest {

    private VulnerabilityDetectorAst detector;
    private SensorContext context;
    private InputFile inputFile;

    @BeforeEach
    void setUp() {
        detector = new VulnerabilityDetectorAst();
        context = mock(SensorContext.class);
        inputFile = mock(InputFile.class);

        when(inputFile.filename()).thenReturn("test.m");
    }

    @Test
    void testDetectAllVulnerabilitiesEmptyContent() {
        String content = "";

        // Should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesSimpleContent() {
        String content = "x = 1 + 2";

        // Should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesWithComments() {
        String content = "(* This is a comment *)\nx = 1 + 2";

        // Should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesMultilineContent() {
        String content = "x = 1 + 2;\ny = 3 + 4;\nz = x * y";

        // Should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileUnderLimit() {
        // Create content with 1000 lines (under the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 1000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should process the file without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileOverLimit() {
        // Create content with 60K lines (over the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 60000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should skip the file but complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesWithException() {
        // Use null sensor to trigger exception path
        VulnerabilityDetectorAst detectorWithNullSensor = new VulnerabilityDetectorAst();
        String content = "x = 1 + 2";

        // This should handle the exception gracefully
        detectorWithNullSensor.detectAllVulnerabilities(inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesMultipleCallsCachesAst() {
        String content = "x = 1 + 2";

        // Call multiple times with same content - should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    // Test deprecated methods (for completeness, even though they're no-ops)

    @SuppressWarnings("deprecation")
    @Test
    void testDetectHardcodedCredentialsDeprecated() {
        String content = "password = \"secret\"";
        assertDoesNotThrow(() -> detector.detectHardcodedCredentials(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectCommandInjectionDeprecated() {
        String content = "Run[\"ls\"]";
        assertDoesNotThrow(() -> detector.detectCommandInjection(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectSqlInjectionDeprecated() {
        String content = "SQLExecute[conn, query]";
        assertDoesNotThrow(() -> detector.detectSqlInjection(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectCodeInjectionDeprecated() {
        String content = "ToExpression[input]";
        assertDoesNotThrow(() -> detector.detectCodeInjection(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectPathTraversalDeprecated() {
        String content = "Import[\"../file\"]";
        assertDoesNotThrow(() -> detector.detectPathTraversal(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectWeakCryptographyDeprecated() {
        String content = "Hash[data]";
        assertDoesNotThrow(() -> detector.detectWeakCryptography(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectSsrfDeprecated() {
        String content = "URLFetch[url]";
        assertDoesNotThrow(() -> detector.detectSsrf(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectInsecureDeserializationDeprecated() {
        String content = "Import[file, \"WXF\"]";
        assertDoesNotThrow(() -> detector.detectInsecureDeserialization(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsafeSymbolDeprecated() {
        String content = "Symbol[name]";
        assertDoesNotThrow(() -> detector.detectUnsafeSymbol(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectXXEDeprecated() {
        String content = "Import[file, \"XML\"]";
        assertDoesNotThrow(() -> detector.detectXXE(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingSanitizationDeprecated() {
        String content = "f[x] := x";
        assertDoesNotThrow(() -> detector.detectMissingSanitization(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectInsecureRandomExpandedDeprecated() {
        String content = "RandomInteger[]";
        assertDoesNotThrow(() -> detector.detectInsecureRandomExpanded(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsafeCloudDeployDeprecated() {
        String content = "CloudDeploy[obj]";
        assertDoesNotThrow(() -> detector.detectUnsafeCloudDeploy(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectDynamicInjectionDeprecated() {
        String content = "Dynamic[expr]";
        assertDoesNotThrow(() -> detector.detectDynamicInjection(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectToExpressionOnInputDeprecated() {
        String content = "ToExpression[input]";
        assertDoesNotThrow(() -> detector.detectToExpressionOnInput(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsanitizedRunProcessDeprecated() {
        String content = "RunProcess[cmd]";
        assertDoesNotThrow(() -> detector.detectUnsanitizedRunProcess(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingCloudAuthDeprecated() {
        String content = "CloudConnect[]";
        assertDoesNotThrow(() -> detector.detectMissingCloudAuth(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectHardcodedApiKeysDeprecated() {
        String content = "apiKey = \"12345\"";
        assertDoesNotThrow(() -> detector.detectHardcodedApiKeys(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectNeedsGetUntrustedDeprecated() {
        String content = "Needs[package]";
        assertDoesNotThrow(() -> detector.detectNeedsGetUntrusted(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectExposingSensitiveDataDeprecated() {
        String content = "Print[password]";
        assertDoesNotThrow(() -> detector.detectExposingSensitiveData(inputFile, content));
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingFormFunctionValidationDeprecated() {
        String content = "FormFunction[...]";
        assertDoesNotThrow(() -> detector.detectMissingFormFunctionValidation(inputFile, content));
        // Should do nothing (deprecated)
    }
}
