package org.sonar.plugins.mathematica.rules;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.MethodSource;
import org.sonar.api.batch.fs.InputFile;

import java.util.stream.Stream;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class VulnerabilityDetectorAstTest {

    private VulnerabilityDetectorAst detector;
    private InputFile inputFile;

    static Stream<String> provideContentSamples() {
        return Stream.of(
            "",
            "x = 1 + 2",
            "(* This is a comment *)\nx = 1 + 2",
            "x = 1 + 2;\ny = 3 + 4;\nz = x * y"
        );
    }

    @BeforeEach
    void setUp() {
        detector = new VulnerabilityDetectorAst();
        inputFile = mock(InputFile.class);

        when(inputFile.filename()).thenReturn("test.m");
    }

    @ParameterizedTest
    @MethodSource("provideContentSamples")
    void testDetectAllVulnerabilitiesVariousContent(String content) {
        // Should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileUnderLimit() {
        // Create content with 1000 lines (under the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 1000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should process the file without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileOverLimit() {
        // Create content with 60K lines (over the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 60000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should skip the file but complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesWithException() {
        // Use null sensor to trigger exception path
        VulnerabilityDetectorAst detectorWithNullSensor = new VulnerabilityDetectorAst();
        String content = "x = 1 + 2";

        // This should handle the exception gracefully
        assertDoesNotThrow(() -> detectorWithNullSensor.detectAllVulnerabilities(inputFile, content));
    }

    @Test
    void testDetectAllVulnerabilitiesMultipleCallsCachesAst() {
        String content = "x = 1 + 2";

        // Call multiple times with same content - should complete without errors
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
        assertDoesNotThrow(() -> detector.detectAllVulnerabilities(inputFile, content));
    }
}
