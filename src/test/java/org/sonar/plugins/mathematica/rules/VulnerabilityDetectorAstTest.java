package org.sonar.plugins.mathematica.rules;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.sonar.api.batch.fs.InputFile;
import org.sonar.api.batch.sensor.SensorContext;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.when;

class VulnerabilityDetectorAstTest {

    private VulnerabilityDetectorAst detector;
    private SensorContext context;
    private InputFile inputFile;

    @BeforeEach
    void setUp() {
        detector = new VulnerabilityDetectorAst();
        context = mock(SensorContext.class);
        inputFile = mock(InputFile.class);

        when(inputFile.filename()).thenReturn("test.m");
    }

    @Test
    void testDetectAllVulnerabilitiesEmptyContent() {
        String content = "";

        // Should complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesSimpleContent() {
        String content = "x = 1 + 2";

        // Should complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesWithComments() {
        String content = "(* This is a comment *)\nx = 1 + 2";

        // Should complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesMultilineContent() {
        String content = "x = 1 + 2;\ny = 3 + 4;\nz = x * y";

        // Should complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileUnderLimit() {
        // Create content with 1000 lines (under the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 1000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should process the file without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesLargeFileOverLimit() {
        // Create content with 60K lines (over the 50K limit)
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < 60000; i++) {
            sb.append("x").append(i).append(" = ").append(i).append(";\n");
        }
        String content = sb.toString();

        // Should skip the file but complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesWithException() {
        // Use null sensor to trigger exception path
        VulnerabilityDetectorAst detectorWithNullSensor = new VulnerabilityDetectorAst();
        String content = "x = 1 + 2";

        // This should handle the exception gracefully
        detectorWithNullSensor.detectAllVulnerabilities(context, inputFile, content);
    }

    @Test
    void testDetectAllVulnerabilitiesMultipleCallsCachesAst() {
        String content = "x = 1 + 2";

        // Call multiple times with same content - should complete without errors
        detector.detectAllVulnerabilities(context, inputFile, content);
        detector.detectAllVulnerabilities(context, inputFile, content);
    }

    // Test deprecated methods (for completeness, even though they're no-ops)

    @SuppressWarnings("deprecation")
    @Test
    void testDetectHardcodedCredentialsDeprecated() {
        String content = "password = \"secret\"";
        detector.detectHardcodedCredentials(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectCommandInjectionDeprecated() {
        String content = "Run[\"ls\"]";
        detector.detectCommandInjection(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectSqlInjectionDeprecated() {
        String content = "SQLExecute[conn, query]";
        detector.detectSqlInjection(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectCodeInjectionDeprecated() {
        String content = "ToExpression[input]";
        detector.detectCodeInjection(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectPathTraversalDeprecated() {
        String content = "Import[\"../file\"]";
        detector.detectPathTraversal(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectWeakCryptographyDeprecated() {
        String content = "Hash[data]";
        detector.detectWeakCryptography(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectSsrfDeprecated() {
        String content = "URLFetch[url]";
        detector.detectSsrf(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectInsecureDeserializationDeprecated() {
        String content = "Import[file, \"WXF\"]";
        detector.detectInsecureDeserialization(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsafeSymbolDeprecated() {
        String content = "Symbol[name]";
        detector.detectUnsafeSymbol(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectXXEDeprecated() {
        String content = "Import[file, \"XML\"]";
        detector.detectXXE(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingSanitizationDeprecated() {
        String content = "f[x] := x";
        detector.detectMissingSanitization(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectInsecureRandomExpandedDeprecated() {
        String content = "RandomInteger[]";
        detector.detectInsecureRandomExpanded(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsafeCloudDeployDeprecated() {
        String content = "CloudDeploy[obj]";
        detector.detectUnsafeCloudDeploy(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectDynamicInjectionDeprecated() {
        String content = "Dynamic[expr]";
        detector.detectDynamicInjection(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectToExpressionOnInputDeprecated() {
        String content = "ToExpression[input]";
        detector.detectToExpressionOnInput(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectUnsanitizedRunProcessDeprecated() {
        String content = "RunProcess[cmd]";
        detector.detectUnsanitizedRunProcess(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingCloudAuthDeprecated() {
        String content = "CloudConnect[]";
        detector.detectMissingCloudAuth(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectHardcodedApiKeysDeprecated() {
        String content = "apiKey = \"12345\"";
        detector.detectHardcodedApiKeys(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectNeedsGetUntrustedDeprecated() {
        String content = "Needs[package]";
        detector.detectNeedsGetUntrusted(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectExposingSensitiveDataDeprecated() {
        String content = "Print[password]";
        detector.detectExposingSensitiveData(context, inputFile, content);
        // Should do nothing (deprecated)
    }

    @SuppressWarnings("deprecation")
    @Test
    void testDetectMissingFormFunctionValidationDeprecated() {
        String content = "FormFunction[...]";
        detector.detectMissingFormFunctionValidation(context, inputFile, content);
        // Should do nothing (deprecated)
    }
}
